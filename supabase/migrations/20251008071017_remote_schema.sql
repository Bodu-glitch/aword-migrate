-- revoke delete on table "public"."profile_root_progress" from "anon";
--
-- revoke insert on table "public"."profile_root_progress" from "anon";
--
-- revoke references on table "public"."profile_root_progress" from "anon";
--
-- revoke select on table "public"."profile_root_progress" from "anon";
--
-- revoke trigger on table "public"."profile_root_progress" from "anon";
--
-- revoke truncate on table "public"."profile_root_progress" from "anon";
--
-- revoke update on table "public"."profile_root_progress" from "anon";
--
-- revoke delete on table "public"."profile_root_progress" from "authenticated";
--
-- revoke insert on table "public"."profile_root_progress" from "authenticated";
--
-- revoke references on table "public"."profile_root_progress" from "authenticated";
--
-- revoke select on table "public"."profile_root_progress" from "authenticated";
--
-- revoke trigger on table "public"."profile_root_progress" from "authenticated";
--
-- revoke truncate on table "public"."profile_root_progress" from "authenticated";
--
-- revoke update on table "public"."profile_root_progress" from "authenticated";
--
-- revoke delete on table "public"."profile_root_progress" from "service_role";
--
-- revoke insert on table "public"."profile_root_progress" from "service_role";
--
-- revoke references on table "public"."profile_root_progress" from "service_role";
--
-- revoke select on table "public"."profile_root_progress" from "service_role";
--
-- revoke trigger on table "public"."profile_root_progress" from "service_role";
--
-- revoke truncate on table "public"."profile_root_progress" from "service_role";
--
-- revoke update on table "public"."profile_root_progress" from "service_role";
--
-- revoke delete on table "public"."profile_sub_root_progress" from "anon";
--
-- revoke insert on table "public"."profile_sub_root_progress" from "anon";
--
-- revoke references on table "public"."profile_sub_root_progress" from "anon";
--
-- revoke select on table "public"."profile_sub_root_progress" from "anon";
--
-- revoke trigger on table "public"."profile_sub_root_progress" from "anon";
--
-- revoke truncate on table "public"."profile_sub_root_progress" from "anon";
--
-- revoke update on table "public"."profile_sub_root_progress" from "anon";
--
-- revoke delete on table "public"."profile_sub_root_progress" from "authenticated";
--
-- revoke insert on table "public"."profile_sub_root_progress" from "authenticated";
--
-- revoke references on table "public"."profile_sub_root_progress" from "authenticated";
--
-- revoke select on table "public"."profile_sub_root_progress" from "authenticated";
--
-- revoke trigger on table "public"."profile_sub_root_progress" from "authenticated";
--
-- revoke truncate on table "public"."profile_sub_root_progress" from "authenticated";
--
-- revoke update on table "public"."profile_sub_root_progress" from "authenticated";
--
-- revoke delete on table "public"."profile_sub_root_progress" from "service_role";
--
-- revoke insert on table "public"."profile_sub_root_progress" from "service_role";
--
-- revoke references on table "public"."profile_sub_root_progress" from "service_role";
--
-- revoke select on table "public"."profile_sub_root_progress" from "service_role";
--
-- revoke trigger on table "public"."profile_sub_root_progress" from "service_role";
--
-- revoke truncate on table "public"."profile_sub_root_progress" from "service_role";
--
-- revoke update on table "public"."profile_sub_root_progress" from "service_role";
--
-- revoke delete on table "public"."profile_sub_vocab_progress" from "anon";
--
-- revoke insert on table "public"."profile_sub_vocab_progress" from "anon";
--
-- revoke references on table "public"."profile_sub_vocab_progress" from "anon";
--
-- revoke select on table "public"."profile_sub_vocab_progress" from "anon";
--
-- revoke trigger on table "public"."profile_sub_vocab_progress" from "anon";
--
-- revoke truncate on table "public"."profile_sub_vocab_progress" from "anon";
--
-- revoke update on table "public"."profile_sub_vocab_progress" from "anon";
--
-- revoke delete on table "public"."profile_sub_vocab_progress" from "authenticated";
--
-- revoke insert on table "public"."profile_sub_vocab_progress" from "authenticated";
--
-- revoke references on table "public"."profile_sub_vocab_progress" from "authenticated";
--
-- revoke select on table "public"."profile_sub_vocab_progress" from "authenticated";
--
-- revoke trigger on table "public"."profile_sub_vocab_progress" from "authenticated";
--
-- revoke truncate on table "public"."profile_sub_vocab_progress" from "authenticated";
--
-- revoke update on table "public"."profile_sub_vocab_progress" from "authenticated";
--
-- revoke delete on table "public"."profile_sub_vocab_progress" from "service_role";
--
-- revoke insert on table "public"."profile_sub_vocab_progress" from "service_role";
--
-- revoke references on table "public"."profile_sub_vocab_progress" from "service_role";
--
-- revoke select on table "public"."profile_sub_vocab_progress" from "service_role";
--
-- revoke trigger on table "public"."profile_sub_vocab_progress" from "service_role";
--
-- revoke truncate on table "public"."profile_sub_vocab_progress" from "service_role";
--
-- revoke update on table "public"."profile_sub_vocab_progress" from "service_role";
--
-- revoke delete on table "public"."profile_vocab_progress" from "anon";
--
-- revoke insert on table "public"."profile_vocab_progress" from "anon";
--
-- revoke references on table "public"."profile_vocab_progress" from "anon";
--
-- revoke select on table "public"."profile_vocab_progress" from "anon";
--
-- revoke trigger on table "public"."profile_vocab_progress" from "anon";
--
-- revoke truncate on table "public"."profile_vocab_progress" from "anon";
--
-- revoke update on table "public"."profile_vocab_progress" from "anon";
--
-- revoke delete on table "public"."profile_vocab_progress" from "authenticated";
--
-- revoke insert on table "public"."profile_vocab_progress" from "authenticated";
--
-- revoke references on table "public"."profile_vocab_progress" from "authenticated";
--
-- revoke select on table "public"."profile_vocab_progress" from "authenticated";
--
-- revoke trigger on table "public"."profile_vocab_progress" from "authenticated";
--
-- revoke truncate on table "public"."profile_vocab_progress" from "authenticated";
--
-- revoke update on table "public"."profile_vocab_progress" from "authenticated";
--
-- revoke delete on table "public"."profile_vocab_progress" from "service_role";
--
-- revoke insert on table "public"."profile_vocab_progress" from "service_role";
--
-- revoke references on table "public"."profile_vocab_progress" from "service_role";
--
-- revoke select on table "public"."profile_vocab_progress" from "service_role";
--
-- revoke trigger on table "public"."profile_vocab_progress" from "service_role";
--
-- revoke truncate on table "public"."profile_vocab_progress" from "service_role";
--
-- revoke update on table "public"."profile_vocab_progress" from "service_role";
--
-- revoke delete on table "public"."profiles" from "anon";
--
-- revoke insert on table "public"."profiles" from "anon";
--
-- revoke references on table "public"."profiles" from "anon";
--
-- revoke select on table "public"."profiles" from "anon";
--
-- revoke trigger on table "public"."profiles" from "anon";
--
-- revoke truncate on table "public"."profiles" from "anon";
--
-- revoke update on table "public"."profiles" from "anon";
--
-- revoke delete on table "public"."profiles" from "authenticated";
--
-- revoke insert on table "public"."profiles" from "authenticated";
--
-- revoke references on table "public"."profiles" from "authenticated";
--
-- revoke select on table "public"."profiles" from "authenticated";
--
-- revoke trigger on table "public"."profiles" from "authenticated";
--
-- revoke truncate on table "public"."profiles" from "authenticated";
--
-- revoke update on table "public"."profiles" from "authenticated";
--
-- revoke delete on table "public"."profiles" from "service_role";
--
-- revoke insert on table "public"."profiles" from "service_role";
--
-- revoke references on table "public"."profiles" from "service_role";
--
-- revoke select on table "public"."profiles" from "service_role";
--
-- revoke trigger on table "public"."profiles" from "service_role";
--
-- revoke truncate on table "public"."profiles" from "service_role";
--
-- revoke update on table "public"."profiles" from "service_role";
--
-- revoke delete on table "public"."roots" from "anon";
--
-- revoke insert on table "public"."roots" from "anon";
--
-- revoke references on table "public"."roots" from "anon";
--
-- revoke select on table "public"."roots" from "anon";
--
-- revoke trigger on table "public"."roots" from "anon";
--
-- revoke truncate on table "public"."roots" from "anon";
--
-- revoke update on table "public"."roots" from "anon";
--
-- revoke delete on table "public"."roots" from "authenticated";
--
-- revoke insert on table "public"."roots" from "authenticated";
--
-- revoke references on table "public"."roots" from "authenticated";
--
-- revoke select on table "public"."roots" from "authenticated";
--
-- revoke trigger on table "public"."roots" from "authenticated";
--
-- revoke truncate on table "public"."roots" from "authenticated";
--
-- revoke update on table "public"."roots" from "authenticated";
--
-- revoke delete on table "public"."roots" from "service_role";
--
-- revoke insert on table "public"."roots" from "service_role";
--
-- revoke references on table "public"."roots" from "service_role";
--
-- revoke select on table "public"."roots" from "service_role";
--
-- revoke trigger on table "public"."roots" from "service_role";
--
-- revoke truncate on table "public"."roots" from "service_role";
--
-- revoke update on table "public"."roots" from "service_role";
--
-- revoke delete on table "public"."sub_vocab" from "anon";
--
-- revoke insert on table "public"."sub_vocab" from "anon";
--
-- revoke references on table "public"."sub_vocab" from "anon";
--
-- revoke select on table "public"."sub_vocab" from "anon";
--
-- revoke trigger on table "public"."sub_vocab" from "anon";
--
-- revoke truncate on table "public"."sub_vocab" from "anon";
--
-- revoke update on table "public"."sub_vocab" from "anon";
--
-- revoke delete on table "public"."sub_vocab" from "authenticated";
--
-- revoke insert on table "public"."sub_vocab" from "authenticated";
--
-- revoke references on table "public"."sub_vocab" from "authenticated";
--
-- revoke select on table "public"."sub_vocab" from "authenticated";
--
-- revoke trigger on table "public"."sub_vocab" from "authenticated";
--
-- revoke truncate on table "public"."sub_vocab" from "authenticated";
--
-- revoke update on table "public"."sub_vocab" from "authenticated";
--
-- revoke delete on table "public"."sub_vocab" from "service_role";
--
-- revoke insert on table "public"."sub_vocab" from "service_role";
--
-- revoke references on table "public"."sub_vocab" from "service_role";
--
-- revoke select on table "public"."sub_vocab" from "service_role";
--
-- revoke trigger on table "public"."sub_vocab" from "service_role";
--
-- revoke truncate on table "public"."sub_vocab" from "service_role";
--
-- revoke update on table "public"."sub_vocab" from "service_role";
--
-- revoke delete on table "public"."sub_vocab_example" from "anon";
--
-- revoke insert on table "public"."sub_vocab_example" from "anon";
--
-- revoke references on table "public"."sub_vocab_example" from "anon";
--
-- revoke select on table "public"."sub_vocab_example" from "anon";
--
-- revoke trigger on table "public"."sub_vocab_example" from "anon";
--
-- revoke truncate on table "public"."sub_vocab_example" from "anon";
--
-- revoke update on table "public"."sub_vocab_example" from "anon";
--
-- revoke delete on table "public"."sub_vocab_example" from "authenticated";
--
-- revoke insert on table "public"."sub_vocab_example" from "authenticated";
--
-- revoke references on table "public"."sub_vocab_example" from "authenticated";
--
-- revoke select on table "public"."sub_vocab_example" from "authenticated";
--
-- revoke trigger on table "public"."sub_vocab_example" from "authenticated";
--
-- revoke truncate on table "public"."sub_vocab_example" from "authenticated";
--
-- revoke update on table "public"."sub_vocab_example" from "authenticated";
--
-- revoke delete on table "public"."sub_vocab_example" from "service_role";
--
-- revoke insert on table "public"."sub_vocab_example" from "service_role";
--
-- revoke references on table "public"."sub_vocab_example" from "service_role";
--
-- revoke select on table "public"."sub_vocab_example" from "service_role";
--
-- revoke trigger on table "public"."sub_vocab_example" from "service_role";
--
-- revoke truncate on table "public"."sub_vocab_example" from "service_role";
--
-- revoke update on table "public"."sub_vocab_example" from "service_role";
--
-- revoke delete on table "public"."sub_vocab_sense" from "anon";
--
-- revoke insert on table "public"."sub_vocab_sense" from "anon";
--
-- revoke references on table "public"."sub_vocab_sense" from "anon";
--
-- revoke select on table "public"."sub_vocab_sense" from "anon";
--
-- revoke trigger on table "public"."sub_vocab_sense" from "anon";
--
-- revoke truncate on table "public"."sub_vocab_sense" from "anon";
--
-- revoke update on table "public"."sub_vocab_sense" from "anon";
--
-- revoke delete on table "public"."sub_vocab_sense" from "authenticated";
--
-- revoke insert on table "public"."sub_vocab_sense" from "authenticated";
--
-- revoke references on table "public"."sub_vocab_sense" from "authenticated";
--
-- revoke select on table "public"."sub_vocab_sense" from "authenticated";
--
-- revoke trigger on table "public"."sub_vocab_sense" from "authenticated";
--
-- revoke truncate on table "public"."sub_vocab_sense" from "authenticated";
--
-- revoke update on table "public"."sub_vocab_sense" from "authenticated";
--
-- revoke delete on table "public"."vocab" from "anon";
--
-- revoke insert on table "public"."vocab" from "anon";
--
-- revoke references on table "public"."vocab" from "anon";
--
-- revoke select on table "public"."vocab" from "anon";
--
-- revoke trigger on table "public"."vocab" from "anon";
--
-- revoke truncate on table "public"."vocab" from "anon";
--
-- revoke update on table "public"."vocab" from "anon";
--
-- revoke delete on table "public"."vocab" from "authenticated";
--
-- revoke insert on table "public"."vocab" from "authenticated";
--
-- revoke references on table "public"."vocab" from "authenticated";
--
-- revoke select on table "public"."vocab" from "authenticated";
--
-- revoke trigger on table "public"."vocab" from "authenticated";
--
-- revoke truncate on table "public"."vocab" from "authenticated";
--
-- revoke update on table "public"."vocab" from "authenticated";
--
-- revoke delete on table "public"."vocab" from "service_role";
--
-- revoke insert on table "public"."vocab" from "service_role";
--
-- revoke references on table "public"."vocab" from "service_role";
--
-- revoke select on table "public"."vocab" from "service_role";
--
-- revoke trigger on table "public"."vocab" from "service_role";
--
-- revoke truncate on table "public"."vocab" from "service_role";
--
-- revoke update on table "public"."vocab" from "service_role";
--
-- revoke delete on table "public"."vocab_examples" from "anon";
--
-- revoke insert on table "public"."vocab_examples" from "anon";
--
-- revoke references on table "public"."vocab_examples" from "anon";
--
-- revoke select on table "public"."vocab_examples" from "anon";
--
-- revoke trigger on table "public"."vocab_examples" from "anon";
--
-- revoke truncate on table "public"."vocab_examples" from "anon";
--
-- revoke update on table "public"."vocab_examples" from "anon";
--
-- revoke delete on table "public"."vocab_examples" from "authenticated";
--
-- revoke insert on table "public"."vocab_examples" from "authenticated";
--
-- revoke references on table "public"."vocab_examples" from "authenticated";
--
-- revoke select on table "public"."vocab_examples" from "authenticated";
--
-- revoke trigger on table "public"."vocab_examples" from "authenticated";
--
-- revoke truncate on table "public"."vocab_examples" from "authenticated";
--
-- revoke update on table "public"."vocab_examples" from "authenticated";
--
-- revoke delete on table "public"."vocab_senses" from "anon";
--
-- revoke insert on table "public"."vocab_senses" from "anon";
--
-- revoke references on table "public"."vocab_senses" from "anon";
--
-- revoke select on table "public"."vocab_senses" from "anon";
--
-- revoke trigger on table "public"."vocab_senses" from "anon";
--
-- revoke truncate on table "public"."vocab_senses" from "anon";
--
-- revoke update on table "public"."vocab_senses" from "anon";
--
-- revoke delete on table "public"."vocab_senses" from "authenticated";
--
-- revoke insert on table "public"."vocab_senses" from "authenticated";
--
-- revoke references on table "public"."vocab_senses" from "authenticated";
--
-- revoke select on table "public"."vocab_senses" from "authenticated";
--
-- revoke trigger on table "public"."vocab_senses" from "authenticated";
--
-- revoke truncate on table "public"."vocab_senses" from "authenticated";
--
-- revoke update on table "public"."vocab_senses" from "authenticated";
--
--
-- revoke delete on table "public"."vocab_sub_roots" from "anon";
--
-- revoke insert on table "public"."vocab_sub_roots" from "anon";
--
-- revoke references on table "public"."vocab_sub_roots" from "anon";
--
-- revoke select on table "public"."vocab_sub_roots" from "anon";
--
-- revoke trigger on table "public"."vocab_sub_roots" from "anon";
--
-- revoke truncate on table "public"."vocab_sub_roots" from "anon";
--
-- revoke update on table "public"."vocab_sub_roots" from "anon";
--
-- revoke delete on table "public"."vocab_sub_roots" from "authenticated";
--
-- revoke insert on table "public"."vocab_sub_roots" from "authenticated";
--
-- revoke references on table "public"."vocab_sub_roots" from "authenticated";
--
-- revoke select on table "public"."vocab_sub_roots" from "authenticated";
--
-- revoke trigger on table "public"."vocab_sub_roots" from "authenticated";
--
-- revoke truncate on table "public"."vocab_sub_roots" from "authenticated";
--
-- revoke update on table "public"."vocab_sub_roots" from "authenticated";
--
-- revoke delete on table "public"."vocab_sub_roots" from "service_role";
--
-- revoke insert on table "public"."vocab_sub_roots" from "service_role";
--
-- revoke references on table "public"."vocab_sub_roots" from "service_role";
--
-- revoke select on table "public"."vocab_sub_roots" from "service_role";
--
-- revoke trigger on table "public"."vocab_sub_roots" from "service_role";
--
-- revoke truncate on table "public"."vocab_sub_roots" from "service_role";
--
-- revoke update on table "public"."vocab_sub_roots" from "service_role";
--
-- alter table "public"."profile_root_progress" drop constraint "profile_root_progress_pkey";
--
-- alter table "public"."profile_sub_root_progress" drop constraint "profile_sub_root_progress_pkey";
--
-- alter table "public"."profile_sub_vocab_progress" drop constraint "profile_sub_vocab_progress_pkey";
--
-- alter table "public"."profile_vocab_progress" drop constraint "profile_vocab_progress_pkey";
--
-- drop index if exists "public"."profile_root_progress_pkey";
--
-- drop index if exists "public"."profile_sub_root_progress_pkey";
--
-- drop index if exists "public"."profile_sub_vocab_progress_pkey";
--
-- drop index if exists "public"."profile_vocab_progress_pkey";
--
-- CREATE UNIQUE INDEX profile_root_progress_profile_id_root_id_key ON public.profile_root_progress USING btree (profile_id, root_id);
--
-- CREATE UNIQUE INDEX profile_sub_root_progress_profile_id_sub_root_id_key ON public.profile_sub_root_progress USING btree (profile_id, sub_root_id);
--
-- CREATE UNIQUE INDEX profile_sub_vocab_progress_profile_id_sub_vocab_id_key ON public.profile_sub_vocab_progress USING btree (profile_id, sub_vocab_id);
--
-- CREATE UNIQUE INDEX profile_vocab_progress_profile_id_vocab_id_key ON public.profile_vocab_progress USING btree (profile_id, vocab_id);
--
-- alter table "public"."profile_root_progress" add constraint "profile_root_progress_profile_id_root_id_key" UNIQUE using index "profile_root_progress_profile_id_root_id_key";
--
-- alter table "public"."profile_sub_root_progress" add constraint "profile_sub_root_progress_profile_id_sub_root_id_key" UNIQUE using index "profile_sub_root_progress_profile_id_sub_root_id_key";
--
-- alter table "public"."profile_sub_vocab_progress" add constraint "profile_sub_vocab_progress_profile_id_sub_vocab_id_key" UNIQUE using index "profile_sub_vocab_progress_profile_id_sub_vocab_id_key";
--
-- alter table "public"."profile_vocab_progress" add constraint "profile_vocab_progress_profile_id_vocab_id_key" UNIQUE using index "profile_vocab_progress_profile_id_vocab_id_key";

ALTER TABLE public.profile_root_progress disable ROW LEVEL SECURITY;

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.get_random_root(exclude_ids uuid[])
 RETURNS SETOF roots
 LANGUAGE sql
 STABLE
AS $function$
  select *
  from roots
  where not (id = any (exclude_ids))
  order by random()
  limit 1;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$BEGIN
  INSERT INTO public.profiles (id, email, full_name, avatar_url)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email),
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;$function$
;


CREATE OR REPLACE FUNCTION public.get_random_vocab_by_roots(
  root_ids uuid[],
  exclude_ids uuid[] DEFAULT '{}',
  limit_count integer DEFAULT 5
)
RETURNS TABLE (
  id uuid,
  root_id uuid,
  word text,
  prefix text,
  infix text,
  postfix text,
  prefix_meaning text,
  infix_meaning text,
  postfix_meaning text,
  phonetic text,
  created_at timestamp with time zone,
  vocab_senses jsonb
)
LANGUAGE sql
STABLE
AS $function$
SELECT
    v.id,
    v.root_id,
    v.word,
    v.prefix,
    v.infix,
    v.postfix,
    v.prefix_meaning,
    v.infix_meaning,
    v.postfix_meaning,
    v.phonetic,
    v.created_at,
    COALESCE(
            (
                SELECT jsonb_agg(
                               jsonb_build_object(
                                       'id', vs.id,
                                       'word', vs.word,
                                       'pos', vs.pos,
                                       'definition', vs.definition
                               ) ORDER BY vs.id
                       )
                FROM public.vocab_senses vs
                WHERE vs.vocab_id = v.id
            ),
            '[]'::jsonb
    ) AS vocab_senses
FROM public.vocab v
WHERE
    (
        root_ids IS NULL
            OR cardinality(array_remove(root_ids, NULL)) = 0
            OR v.root_id = ANY(array_remove(root_ids, NULL))
        )
  AND (
    exclude_ids IS NULL
        OR cardinality(array_remove(exclude_ids, NULL)) = 0
        OR NOT (v.id = ANY(array_remove(exclude_ids, NULL)))
    )
ORDER BY random()
    LIMIT greatest(limit_count, 0);
$function$;
